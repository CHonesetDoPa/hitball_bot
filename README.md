# 击打高玩机器人

群友太嚣张了，忍不了了，怎么办？

还好，聪明的CC发明了击打高玩机器人！它可以让你合法地暴打群友的高玩！

## ✨ 主要特色

• **智能用户识别**
  ◦ 自动同步用户ID和用户名信息
  ◦ 支持通过用户名、用户ID、回复、转发等多种方式击打
  ◦ 数据以用户ID为主键，确保唯一性和一致性
  ◦ 实时通过Telegram API获取最新用户信息

• **功能优势**
  ◦ 不用真的动手，但是效果拔群
  ◦ 自动统计战绩，让你知道谁的高玩最抗揍
  ◦ 防止自残，毕竟打自己的高玩是没意义的
  ◦ 数据持久化，重启也不会丢失你的光辉战绩
  ◦ 机器人反弹保护，攻击机器人会反弹伤害

• **智能限制**
  ◦ 速率限制防刷屏，连续违规会被禁言
  ◦ 群聊仅限击打命令，其他功能私聊使用
  ◦ 自动成就系统，记录特殊里程碑

• **缺点**
  ◦ 只能线上击打高玩，无法造成真实伤害
  ◦ 可能会让群友记恨你

## 使用效果

我们先来打个人试试吧！

```
用户A: /hit @用户B
```

```
💥 用户A 给了 @用户B 一记重拳！
📊 @用户B 已被击打 5 次！
```

看起来效果不错，用户B被揍得挺惨的！

再看看排行榜——

```
/leaderboard
```

```
🏆 击打排行榜 🏆
🥇 @用户B - 5 次
🥈 @用户E - 3 次  
🥉 @用户F - 2 次
```

用户B果然是抗击打冠军！

好，接下来我们来查看一下统计数据——

```
/stats @用户B
```

```
📊 击打统计报告
@用户B 已被击打 5 次！
```

数据记录得很详细呢！

## 原理

其实原理非常简单。群友在群里说话的时候，你回复他们的消息然后发送 `/hit`，机器人就会记录下这次击打。

### 数据存储

举个例子，张三被打了，机器人会在 `data.json` 里记录：

```json
{
  "hitData": {
    "123456789": {
      "name": "张三",
      "username": "zhangsan",
      "count": 1,
      "firstHitDate": "2024-01-01T10:00:00.000Z",
      "lastHitDate": "2024-01-01T10:00:00.000Z"
    }
  },
  "bounceAchievements": {
    "123456789": {
      "name": "张三",
      "username": "zhangsan", 
      "hasBounceAchievement": true,
      "firstBounceDate": "2024-01-01T10:30:00.000Z"
    }
  }
}
```

下次张三又被打了，`count` 就会变成 2。就这么简单！

### 自动用户信息同步

机器人现在能够智能地同步和维护用户信息：

- **实时同步**: 每当用户发送消息、被回复或被转发时，自动更新用户信息
- **API获取**: 通过Telegram API获取群组成员的最新信息
- **双向查找**: 支持通过用户ID或用户名查找用户
- **数据一致性**: 确保ID和用户名的映射关系准确无误

### 排行榜生成

每次有人查看排行榜的时候，机器人就把所有人的击打次数拿出来排个序，然后显示前几名。

机器学习？不需要。神经网络？也不需要。就是个智能的计数器！

## 使用方法

首先你需要有一个Telegram账号，然后找到 [@BotFather](https://t.me/botfather) 创建一个机器人。

获得token之后，把这个仓库clone回去，在 `.env` 文件里填入你的token，然后 `pnpm install && pnpm start`，就行了。

### 命令接口

```bash
# 基础击打命令
/hit @用户名       # 击打指定用户名的高玩
/hit 123456789     # 通过用户ID击打高玩
/hit               # 回复某人消息后使用，击打被回复用户的高玩

# 统计查询命令  
/stats             # 查看自己的高玩受击统计
/stats @用户名     # 查看指定用户的高玩受击统计
/stats 123456789   # 通过用户ID查看统计
/leaderboard       # 查看高玩受击排行榜

# 成就系统
/achievements      # 查看自己的高玩成就
/achievements @用户名  # 查看指定用户的高玩成就
/achievements 123456789  # 通过用户ID查看成就

# 用户查询功能
/query @用户名     # 查询用户详细信息
/query 123456789   # 通过用户ID查询信息
/query             # 回复某人消息后使用，查询被回复用户信息

# 管理功能
/sync              # 同步群组成员信息 (仅管理员)

# 帮助信息
/help              # 获取完整使用指南
/start             # 开始使用机器人
```

### 新功能特性

#### 🔄 自动用户信息同步
- **实时同步**: 用户发消息时自动更新信息
- **API获取**: 通过Telegram API获取群组成员信息  
- **智能识别**: 支持用户名、ID、回复、转发等多种方式
- **数据一致性**: 确保ID和用户名映射准确无误

#### 🆔 优化的数据存储
- **用户ID为主键**: 使用Telegram用户ID作为数据主键，解决用户名重复问题
- **用户名不区分大小写**: 自动处理用户名的大小写差异
- **多种击打方式**: 支持通过用户名、用户ID、回复消息等方式击打
- **向后兼容**: 兼容旧的用户名数据格式

#### 🚦 智能速率限制与反垃圾机制
- **击打命令**: 3秒冷却时间，防止恶意刷屏
- **其他命令**: 1秒冷却时间，防止频繁请求
- **自动禁言**: 连续违规触发冷却5次后，自动禁言5分钟
- **智能计数**: 违规计数会在1分钟后自动重置

#### 🛡️ 机器人保护机制
- **攻击反弹**: 试图攻击机器人的用户会被反弹攻击
- **自动反击**: 攻击者自己的高玩会受到反弹伤害
- **反击成就**: 首次攻击机器人会解锁"机器人挑战者"成就
- **数据统计**: 反弹攻击会计入正常的高玩击打统计中

#### 🔒 群聊命令限制
- **群聊环境**: 只允许使用 `/hit` 命令，保持群聊简洁
- **私聊环境**: 无限制，可使用所有功能
- 在群聊中使用受限命令会提示私聊机器人

#### ⚙️ 环境变量配置

在 `.env` 文件中可以自定义设置:

```env
# 必需配置
BOT_TOKEN=your_bot_token_here
BOT_USERNAME=your_bot_username_here

# 可选：速率限制配置（毫秒）
HIT_COOLDOWN=3000      # 击打命令冷却时间，默认3秒
COMMAND_COOLDOWN=1000  # 其他命令冷却时间，默认1秒

# 可选：反垃圾配置
MAX_VIOLATIONS=5       # 最大违规次数，默认5次
MUTE_TIME=300         # 禁言时间（秒），默认5分钟
VIOLATION_RESET_TIME=60000  # 违规计数重置时间（毫秒），默认1分钟
```

### 使用场景

1. **群聊击打**: 在群聊中回复某人消息并发送 `/hit`，或使用 `/hit @用户名`，或使用 `/hit 用户ID`
2. **数据查询**: 私聊机器人使用 `/stats`、`/leaderboard`、`/achievements` 等命令
3. **成就系统**: 不同的击打次数会解锁特殊成就和称号
4. **通过ID击打**: 即使用户没有用户名也可以通过用户ID进行击打

## 结束

这是一个狠命击打你ball的bot，现在还带有智能限制和群聊优化功能！
